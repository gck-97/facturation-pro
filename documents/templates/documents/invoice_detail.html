{% extends 'base.html' %}
{% block title %}{{ page_title }}{% endblock %}
{% block content %}
<div class="invoice-container">
    <p>
        <a href="{% url 'documents:invoice_list' %}" class="btn btn-outline-secondary btn-sm mb-4">
            &laquo; Retour √† la liste des factures
        </a>
    </p>
    <div class="invoice-header">
        <h1 class="display-5">Facture N¬∞ {{ invoice.invoice_number }}</h1>
        <div class="row mt-3">
            <div class="col-md-6">
                <p>
                    <strong>Date d'√©mission :</strong> {{ invoice.issue_date|date:"d/m/Y" }}<br>
                    <strong>Date d'√©ch√©ance :</strong> {{ invoice.due_date|date:"d/m/Y" }}
                </p>
            </div>
            <div class="col-md-6 text-md-end">
                <div class="d-flex align-items-center justify-content-md-end" style="gap: 10px;">
                    <strong>Statut :</strong>
                    <span id="invoice-status-badge">
                        {% if invoice.status == 'Pay√©e' %}
                            <span class="badge bg-success fs-6">{{ invoice.get_status_display }}</span>
                        {% elif invoice.status == 'En retard' %}
                            <span class="badge bg-danger fs-6">{{ invoice.get_status_display }}</span>
                        {% elif invoice.status == 'Envoy√©e' %}
                            <span class="badge bg-primary fs-6">{{ invoice.get_status_display }}</span>
                        {% elif invoice.status == 'Annul√©e' %}
                            <span class="badge bg-secondary fs-6">{{ invoice.get_status_display }}</span>
                        {% else %}
                            <span class="badge bg-light text-dark border fs-6">{{ invoice.get_status_display }}</span>
                        {% endif %}
                    </span>
                    <form action="{% url 'documents:update_invoice_status' invoice.id %}" method="post" class="d-inline ms-2">
                        {% csrf_token %}
                        <select name="status" class="form-select form-select-sm d-inline-block w-auto" onchange="this.form.submit()">
                            <option value="Brouillon" {% if invoice.status == 'Brouillon' %}selected{% endif %}>Brouillon</option>
                            <option value="Envoy√©e" {% if invoice.status == 'Envoy√©e' %}selected{% endif %}>Envoy√©e</option>
                            <option value="Pay√©e" {% if invoice.status == 'Pay√©e' %}selected{% endif %}>Pay√©e</option>
                            <option value="En retard" {% if invoice.status == 'En retard' %}selected{% endif %}>En retard</option>
                            <option value="Annul√©e" {% if invoice.status == 'Annul√©e' %}selected{% endif %}>Annul√©e</option>
                        </select>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-md-6">
            <h2 class="h4">Client</h2>
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">{{ invoice.client.nom }}</h5>
                    <p class="card-text">
                        {{ invoice.client.adresse_ligne1 }}{% if invoice.client.adresse_ligne2 %}, {{ invoice.client.adresse_ligne2 }}{% endif %}<br>
                        {{ invoice.client.code_postal }} {{ invoice.client.ville }}<br>
                        {{ invoice.client.pays }}<br>
                        {% if invoice.client.numero_tva %}<small class="text-muted">N¬∞ TVA : {{ invoice.client.numero_tva }}</small>{% endif %}
                    </p>
                </div>
            </div>
        </div>
    </div>

    <h2 class="mt-4 h4">Articles Factur√©s</h2>
    <div class="table-responsive">
        <table class="table table-bordered table-striped">
            <thead class="table-light">
                <tr>
                    <th>Description</th>
                    <th class="text-end">Quantit√©</th>
                    <th class="text-end">Prix U. HTVA (‚Ç¨)</th>
                    <th class="text-end">Total Ligne HTVA (‚Ç¨)</th>
                </tr>
            </thead>
            <tbody>
                {% for item in invoice.items.all %}
                <tr>
                    <td>{{ item.description }}</td>
                    <td class="text-end">{{ item.quantity|floatformat:2 }}</td>
                    <td class="text-end">{{ item.unit_price_htva|floatformat:2 }}</td>
                    <td class="text-end">{{ item.total_line_htva|floatformat:2 }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div id="invoice-totals-ajax">
        {% include "documents/_invoice_totals.html" %}
    </div>

    <div class="card mb-4">
        <div class="card-body">
            <form id="add-payment-ajax-form" data-invoice-id="{{ invoice.id }}">
                {% csrf_token %}
                <div class="row">
                    <div class="col">
                        <input type="number" step="0.01" min="0" name="amount_paid" required class="form-control" placeholder="Montant pay√©">
                    </div>
                    <div class="col">
                        <input type="date" name="payment_date" class="form-control" value="{{ today|date:'Y-m-d' }}">
                    </div>
                    <div class="col">
                        <select name="payment_method" class="form-select">
                            {% for code, name in invoice.payments.model.PaymentMethod.choices %}
                            <option value="{{ code }}">{{ name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col">
                        <input type="text" name="reference" class="form-control" placeholder="R√©f√©rence (facultatif)">
                    </div>
                    <div class="col">
                        <button type="submit" class="btn btn-primary">Ajouter Paiement</button>
                    </div>
                </div>
                <div id="payment-form-errors" class="text-danger small mt-2"></div>
            </form>
        </div>
    </div>

    <div id="payments-table-ajax">
        {% include "documents/_payments_table.html" %}
    </div>

    {% if invoice.notes %}
    <div class="card mt-4">
        <div class="card-header">Notes</div>
        <div class="card-body">
            <p class="card-text">{{ invoice.notes|linebreaksbr }}</p>
        </div>
    </div>
    {% endif %}

    <div class="mt-4 text-center">
        <a href="{% url 'documents:view_invoice_pdf' invoice.id %}" target="_blank" class="btn btn-success btn-lg">T√©l√©charger PDF</a>

        {% if invoice.client.email %}
        <form method="post" action="{% url 'documents:send_invoice_email' invoice.id %}" style="display:inline;">
            {% csrf_token %}
            <button type="submit" class="btn btn-primary btn-lg ms-2">
                üìß Envoyer par email au client
            </button>
        </form>
        {% else %}
            <span class="ms-2 text-danger">Aucune adresse email pour ce client</span>
        {% endif %}

        {% if invoice.status != 'Annul√©e' %}
            <a href="{% url 'documents:create_credit_note_from_invoice' invoice.id %}" class="btn btn-warning btn-lg ms-2">Cr√©er Note de Cr√©dit</a>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// CSRF utils Django
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
const csrftoken = getCookie('csrftoken');

document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('add-payment-ajax-form');
    const errorsDiv = document.getElementById('payment-form-errors');
    if (form) {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            errorsDiv.innerHTML = '';
            const invoiceId = form.getAttribute('data-invoice-id');
            const url = `/documents/invoice/${invoiceId}/ajax_add_payment/`;
            const data = new FormData(form);

            fetch(url, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': csrftoken
                },
                body: data,
            })
            .then(res => res.json())
            .then(resp => {
                if (resp.success) {
                    document.getElementById('payments-table-ajax').innerHTML = resp.payments_html;
                    document.getElementById('invoice-totals-ajax').innerHTML = resp.totals_html;
                    form.reset();
                    if (resp.status) {
                        let badgeHtml = '';
                        switch(resp.status) {
                            case 'Pay√©e':
                                badgeHtml = '<span class="badge bg-success fs-6">Pay√©e</span>'; break;
                            case 'En retard':
                                badgeHtml = '<span class="badge bg-danger fs-6">En retard</span>'; break;
                            case 'Envoy√©e':
                                badgeHtml = '<span class="badge bg-primary fs-6">Envoy√©e</span>'; break;
                            case 'Annul√©e':
                                badgeHtml = '<span class="badge bg-secondary fs-6">Annul√©e</span>'; break;
                            default:
                                badgeHtml = '<span class="badge bg-light text-dark border fs-6">'+resp.status+'</span>';
                        }
                        document.getElementById('invoice-status-badge').innerHTML = badgeHtml;
                    }
                } else if (resp.errors) {
                    for (const field in resp.errors) {
                        errorsDiv.innerHTML += resp.errors[field].join('<br>') + '<br>';
                    }
                } else if (resp.error) {
                    errorsDiv.textContent = resp.error;
                }
            });
        });
    }

    // Suppression paiement AJAX (d√©l√©gu√©e)
    document.body.addEventListener('submit', function(e) {
        const form = e.target;
        if (form.classList.contains('delete-payment-ajax-form')) {
            e.preventDefault();
            if (!form.hasAttribute('data-confirmed')) {
                if (!confirm('Supprimer ce paiement‚ÄØ?')) return false;
                form.setAttribute('data-confirmed', '1');
            }
            const paymentId = form.getAttribute('data-payment-id');
            const invoiceId = document.getElementById('add-payment-ajax-form').getAttribute('data-invoice-id');
            const url = `/documents/payment/${paymentId}/ajax_delete/`;
            const data = new FormData(form);
            fetch(url, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': csrftoken
                },
                body: data
            })
            .then(res => res.json())
            .then(resp => {
                if (resp.success) {
                    document.getElementById('payments-table-ajax').innerHTML = resp.payments_html;
                    document.getElementById('invoice-totals-ajax').innerHTML = resp.totals_html;
                    if (resp.status) {
                        let badgeHtml = '';
                        switch(resp.status) {
                            case 'Pay√©e':
                                badgeHtml = '<span class="badge bg-success fs-6">Pay√©e</span>'; break;
                            case 'En retard':
                                badgeHtml = '<span class="badge bg-danger fs-6">En retard</span>'; break;
                            case 'Envoy√©e':
                                badgeHtml = '<span class="badge bg-primary fs-6">Envoy√©e</span>'; break;
                            case 'Annul√©e':
                                badgeHtml = '<span class="badge bg-secondary fs-6">Annul√©e</span>'; break;
                            default:
                                badgeHtml = '<span class="badge bg-light text-dark border fs-6">'+resp.status+'</span>';
                        }
                        document.getElementById('invoice-status-badge').innerHTML = badgeHtml;
                    }
                }
            });
        }
    });
});
</script>
{% endblock %}

