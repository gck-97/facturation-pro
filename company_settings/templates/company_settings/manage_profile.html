{% extends "base.html" %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'vendor/coloris/coloris.min.css' %}">
<div class="container mt-4">
  <div class="row">
    <div class="col-md-6">
      <h2>Profil de l'entreprise</h2>
      <form id="profile-form" method="post" enctype="multipart/form-data" autocomplete="off">
        {% csrf_token %}
        {{ form.as_p }}
        {% if profile.logo %}
            <img src="{{ profile.logo.url }}" alt="Logo" style="max-height:120px;margin-bottom:10px;">
        {% endif %}
        <button type="submit" class="btn btn-primary mt-3">Enregistrer</button>
      </form>
    </div>
    <div class="col-md-6">
      <h3>Aperçu PDF</h3>
      <iframe id="pdf-preview" style="width:100%;height:650px;border:1px solid #ccc;"></iframe>
    </div>
  </div>
</div>

<script src="{% static 'vendor/coloris/coloris.min.js' %}"></script>
<script>
document.addEventListener("DOMContentLoaded", function() {
    const colorInput = document.getElementById("id_accent_color");
    const form = document.getElementById("profile-form");
    const iframe = document.getElementById("pdf-preview");
    let previousUrl = null;

    // Initialiser Coloris sur le champ couleur
    if (colorInput) {
        colorInput.classList.add('coloris');
        colorInput.setAttribute('data-coloris', '');
    }

    if (window.Coloris) {
        Coloris({
            theme: 'pill',
            swatches: [
                '#000000', '#ffffff', '#ff0000', '#00ff00', '#0000ff',
                '#ff9900', '#ff00ff', '#00ffff', '#3390ff', '#ff3333', '#e933ff', '#33ff52'
            ]
        });
    } else {
        console.error("Coloris n'est pas chargé !");
    }

    function updatePDF() {
        const formData = new FormData(form);
        fetch("{% url 'live_pdf_preview' %}", {
            method: "POST",
            body: formData,
            headers: {'X-Requested-With': 'XMLHttpRequest'},
        })
        .then(response => {
            if(response.ok) return response.blob();
            else throw response;
        })
        .then(blob => {
            if (previousUrl) {
                URL.revokeObjectURL(previousUrl);
            }
            previousUrl = URL.createObjectURL(blob);
            iframe.src = previousUrl;
        })
        .catch(err => {
            iframe.src = "";
        });
    }

    // Rafraîchir l'aperçu à chaque modification dans le formulaire
    form.querySelectorAll("input, textarea, select").forEach(el => {
        el.addEventListener("input", updatePDF);
        el.addEventListener("change", updatePDF);
    });

    // Écouteurs spécifiques sur le champ couleur Coloris
    if (colorInput) {
        colorInput.addEventListener('input', () => {
            console.log('input event détecté sur couleur', colorInput.value);
            updatePDF();
        });
        colorInput.addEventListener('coloris:change', () => {
            console.log('coloris:change event détecté sur couleur', colorInput.value);
            updatePDF();
        });
    }

    // Rafraîchir si changement du logo
    const logoInput = document.getElementById("id_logo");
    if (logoInput) {
        logoInput.addEventListener('change', updatePDF);
    }

    // Rafraîchir à l'ouverture
    updatePDF();
});
</script>
{% endblock %}
